/*!
* System: Aurora Internet Banking Platform
* Class:  Nationwide.Aurora.Transactions.Scripts.FullStatement
*
* Copyright (c) Nationwide Building Society 2010. All rights reserved.
*/
$(function(){function drawTransactions(){var data,checkBoxes,filterName,filters;if(enterDatesStart.closest("form").valid()){if(data={start:enterDatesStart.val(),end:enterDatesEnd.val(),__token:$.viewData.token},filterOptions.length>0){if(checkBoxes=$("input:checkbox:checked"),checkBoxes.length===0){updatePageMessages($.viewData.noFiltersMessage);return}filters=[];checkBoxes.each(function(){filterName=$(this).attr("name");jQuery.inArray(filterName,$.viewData.filterNames)&&filters.push(filterName)});$.extend(data,{filters:filters})}blockElement(statementContainer);$.ajax({type:"POST",dataType:"json",url:$.viewData.url,traditional:!0,data:data,success:updateTransactions})}}function updateTransactions(data){if(!checkTransactionsError(data.TransactionsError)){var tableHtml=[],date,amount,paidOut,paidIn;$.each(data.Transactions||[],function(){date=new Date(parseInt(this.Date.substr(6)));amount=$.viewData.currencySymbol+Math.abs(this.Amount).toFixed(2);paidIn=this.IsPaidIn?amount:" ";paidOut=this.IsPaidIn?" ":amount;tableHtml.push("<tr><td>"+$.date.format(date,"dd MMM yyyy")+"<div style='display: none'> - "+this.Sequence+"<\/div><\/td><td>"+this.TransactionType+"<\/td><td>"+this.Description+"<\/td><td class='currency'>"+paidOut+"<\/td><td class='currency'>"+paidIn+"<\/td><td class='amountCell currency'>"+$.viewData.currencySymbol+this.RunningBalance.toFixed(2)+"<\/td><\/tr>")});tableHtml.length?statementTableBody.html(tableHtml.join("")):statementTableBody.html("");data.FiltersText&&$("#transaction-display-filters").html(data.FiltersText);updateDatesDisplayed();updatePageMessages(data.PageMessages);statementContainer.unblock();statementTable.trigger("update");data.Transactions&&statementTable.trigger("sorton",[$.viewData.userSortPreference||[[0,0]]]);updateDownloadLink();$(window).trigger("resize")}}function checkTransactionsError(errorMessage){return errorMessage?(statementErrorMessage.html(errorMessage),statementError.show(),statementContainer.hide(),!0):(statementErrorMessage.html(""),statementError.hide(),statementContainer.show(),!1)}function updatePageMessages(pageMessages){pageMessageArea.pageMessageArea("clear").pageMessageArea("hide");pageMessages&&(typeof pageMessages.length=="undefined"?pageMessageArea.pageMessageArea("show",{messageItem:pageMessages}):pageMessageArea.pageMessageArea("show",{messageItem:pageMessages[0]}))}function updateDatesDisplayed(){var startDate=$.date.parse(enterDatesStart.val()),startDateString=$.date.format(startDate,"dd MMM yyyy"),endDate=$.date.parse(enterDatesEnd.val()),endDateString=$.date.format(endDate,"dd MMM yyyy");$("#date-display-dates").html(startDateString+" - "+endDateString)}function addDatePanelStyling(){enterDatesLink.hasClass("expanded")?(statementFilter.addClass("split-top-blue-content-pod statement-filter-revealed").removeClass("full-blue-container"),enterDatesCorners.hide()):(statementFilter.removeClass("split-top-blue-content-pod statement-filter-revealed").addClass("full-blue-container"),enterDatesCorners.show())}function updateDownloadLink(){var midataLinkPresent=downloadMiDataLink.length>0,transactionsPresent=statementTableBody.length>0&&statementTableBody.children().length>0;midataLinkPresent?transactionsPresent?(downloadCsvLink.show(),downloadOfxLink.show()):(downloadCsvLink.hide(),downloadOfxLink.hide()):transactionsPresent?downloadLink.show():downloadLink.hide();transactionsPresent?(printLink.show(),applyTableSorter()):printLink.hide()}function applyTableSorter(){appliedSorterFlag===!1&&(statementTable.tablesorter({sortList:$.viewData.userSortPreference||[[0,0]],headers:{0:{sorter:"transaction-sequence"},2:{sorter:!1},3:{sorter:!1},4:{sorter:!1},5:{sorter:!1}}}).registerSortListener(),appliedSorterFlag=!0)}var enterDatesLink=$("#enter-date-reveal-link"),enterDatesCorners=$(".blue-pod-se, .blue-pod-sw"),enterDatesStart=$("#statement-from-date"),enterDatesEnd=$("#statement-to-date"),statementFilter=$(".statement-filter"),statementError=$("#full-statement-error"),statementErrorMessage=$("#full-statement-error p"),statementContainer=$("#full-statement-container"),statementTable=$("#full-statement-sortable-table"),statementTableBody=$("#full-statement-sortable-table tbody"),statementTableBodyRow=$("#full-statement-sortable-table tbody tr"),filterOptions=$("#filter-options"),filterReveal=$("#edit-transaction-type"),rangeButtons=$("#stageInner ul.short-range-buttons a"),stageErrorMsg=$("#stageInner div.error-msg"),pageMessageArea=$("#pageMessageArea"),moneyPaidOutCheckboxes=$("#filter-options .first-col, #filter-options .second-col").find(":checkbox:not('#TransactionFilterMapping_AllMoneyPaidOut')"),moneyPaidInCheckboxes=$("#filter-options .third-col, #filter-options .fourth-col").find(":checkbox:not('#TransactionFilterMapping_AllMoneyPaidIn')"),allPaidOutCheckbox=$("#TransactionFilterMapping_AllMoneyPaidOut"),allPaidInCheckbox=$("#TransactionFilterMapping_AllMoneyPaidIn"),downloadLink=$(".downloadFile"),printLink=$("#stageUtilPrint"),stageUtilLinks=$("#stageUtilLinks"),downloadCsvLink=$(".downloadCsvLink"),downloadOfxLink=$(".downloadOfxLink"),downloadMiDataLink=$(".downloadMiDataLink"),appliedSorterFlag=!1;$("#accountTwistie").twistie({areaName:"Statements",viewName:"FullStatement"});enterDatesLink.twistie({areaName:"Statements",viewName:"FullStatement",revealContainer:"date-options"});filterReveal.twistie({areaName:"Statements",viewName:"FullStatement",revealContainer:"filter-options"});pageMessageArea.pageMessageArea();$("#date-filter-update").unbind("click.disableSubmitsOnClick").click(function(e){e.preventDefault();enterDatesStart.closest("form").valid()&&(enterDatesLink.trigger("click"),drawTransactions())});$(document).on("click","#btnPopRangeFields",function(e){e.preventDefault();enterDatesStart.change();enterDatesLink.trigger("click");drawTransactions()});$("#close-dates-reveal").click(function(e){e.preventDefault();enterDatesLink.trigger("click")});$("#transaction-reveal-update").unbind("click.disableSubmitsOnClick").click(function(e){e.preventDefault();drawTransactions()});$("#transaction-reveal-reset").click(function(e){e.preventDefault();moneyPaidOutCheckboxes.add(moneyPaidInCheckboxes).add(allPaidOutCheckbox).add(allPaidInCheckbox).prop("checked",!0);filterReveal.trigger("click");drawTransactions()});$("#close-transaction-reveal").click(function(e){e.preventDefault();filterReveal.trigger("click")});allPaidOutCheckbox.click(function(){var checked=this.checked;moneyPaidOutCheckboxes.prop("checked",checked)});allPaidInCheckbox.click(function(){allPaidInCheckbox.prop("checked")?moneyPaidInCheckboxes.prop("checked",!0):moneyPaidInCheckboxes.prop("checked",!1)});moneyPaidOutCheckboxes.click(function(){moneyPaidOutCheckboxes.filter(":not(':checked')").length?allPaidOutCheckbox.prop("checked",!1):allPaidOutCheckbox.prop("checked",!0)});moneyPaidInCheckboxes.click(function(){moneyPaidInCheckboxes.filter(":not(':checked')").length?allPaidInCheckbox.prop("checked",!1):allPaidInCheckbox.prop("checked",!0)});rangeButtons.click(function(e){e.preventDefault();var selectedButton=$(this),start;if(!selectedButton.hasClass("disabled")){rangeButtons.filter(".selected").removeClass("selected");selectedButton.addClass("selected");switch(selectedButton[0].id){case"last-month-btn":start=$("#OneMonthAgoDate").val();break;case"last-3-month-btn":start=$("#ThreeMonthsAgoDate").val();break;case"last-6-month-btn":start=$("#SixMonthsAgoDate").val();break;case"last-12-month-btn":start=$("#TwelveMonthsAgoDate").val();break;default:start=$("#OneMonthAgoDate").val();break}enterDatesStart.val(start.substring(0,10));enterDatesEnd.val($.date.format(new Date,"dd/MM/yyyy"));drawTransactions()}});updateDownloadLink();checkTransactionsError($.viewData.TransactionsError)===!1&&statementTableBodyRow.length>0&&applyTableSorter();$(window).resize(addDatePanelStyling);$(window).trigger("resize")})